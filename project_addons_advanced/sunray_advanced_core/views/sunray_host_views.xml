<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Extend sunray.host form view to add Remote Authentication fields -->
        <record id="sunray_host_form_advanced" model="ir.ui.view">
            <field name="name">sunray.host.form.advanced</field>
            <field name="model">sunray.host</field>
            <field name="inherit_id" ref="sunray_core.view_sunray_host_form"/>
            <field name="arch" type="xml">
                <xpath expr="//sheet" position="before">
                    <header>
                        <field name="state" widget="statusbar" statusbar_visible="unprotected,locked,deployment,protected"/>
                    </header>
                </xpath>
                <xpath expr="//group[@name='protection_status']" position="before">
                    <group string="Deployment Mode" name="deployment_mode">
                        <group>
                            <field name="deployment_mode" widget="boolean_toggle"/>
                            <field name="golive_date" invisible="not deployment_mode"/>
                        </group>
                        <group invisible="not deployment_mode">
                            <field name="days_until_golive"/>
                            <field name="deployment_session_ttl"
                                widget="integer"
                                help="Session duration in seconds (default: 7200 = 2 hours)"/>
                        </group>
                    </group>
                </xpath>

                <!-- Add Remote Authentication section after configuration tab -->
                <group name="waf_integration_group" position="after">
                    <group string="Remote Authentication Settings" name="remote_auth_settings_group">
                        <group>
                            <field name="remote_auth_enabled"/>
                            <field name="remote_auth_session_ttl"
                                    invisible="not remote_auth_enabled"
                                    required="remote_auth_enabled"/>
                            <field name="remote_auth_max_session_ttl"
                                    invisible="not remote_auth_enabled"
                                    required="remote_auth_enabled"/>
                        </group>
                        <group>
                            <div class="alert alert-info" role="alert" invisible="not remote_auth_enabled" colspan="2">
                                <p><strong>Remote Authentication Configuration:</strong></p>
                                <ul>
                                    <li>Default Session Duration: <field name="remote_auth_session_ttl" readonly="1"/> seconds</li>
                                    <li>Maximum Session Duration: <field name="remote_auth_max_session_ttl" readonly="1"/> seconds</li>
                                    <li>Session Management Access: <field name="session_mgmt_ttl" readonly="1"/> seconds</li>
                                </ul>
                                <p class="mb-0">
                                    <i class="fa fa-info-circle"/> Remote authentication allows users to authenticate
                                    using their mobile device while accessing from a different computer.
                                </p>
                            </div>
                        </group>
                    </group>

                    <group string="Session Management" name="session_management_group">
                        <group>
                            <field name="session_mgmt_enabled"/>
                        </group>
                        <group>
                            <field name="session_mgmt_ttl"
                                    invisible="not session_mgmt_enabled"
                                    required="session_mgmt_enabled"/>
                        </group>

                    </group>
                </group>

            </field>
        </record>

        <!-- Extend sunray.host tree view to show remote auth status -->
        <record id="sunray_host_tree_advanced" model="ir.ui.view">
            <field name="name">sunray.host.tree.advanced</field>
            <field name="model">sunray.host</field>
            <field name="inherit_id" ref="sunray_core.sunray_host__listview"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='config_version']" position="after">
                    <field name="state"
                           decoration-warning="state == 'locked'"
                           decoration-info="state == 'deployment'"
                           decoration-success="state == 'protected'"
                           decoration-danger="state == 'unprotected'"
                           decoration-muted="state == 'archived'"
                           widget="badge"/>
                </xpath>
                <xpath expr="//field[@name='sunray_worker_id']" position="after">
                    <field name="golive_date" optional="hide"/>
                    <field name="days_until_golive" optional="hide"/>
                </xpath>

                <!-- Add remote auth enabled column -->
                <xpath expr="//field[@name='block_all_traffic']" position="after">
                    <field name="deployment_mode" string="Deployment" optional="show" widget="boolean_toggle"/>
                    <field name="remote_auth_enabled"
                           widget="boolean_toggle"
                           string="Remote Auth"
                           optional="show"/>
                </xpath>
            </field>
        </record>

        <!-- Add search filters for remote authentication -->
        <record id="sunray_host_search_advanced" model="ir.ui.view">
            <field name="name">sunray.host.search.advanced</field>
            <field name="model">sunray.host</field>
            <field name="inherit_id" ref="sunray_core.view_sunray_host_search"/>
            <field name="arch" type="xml">
                <!-- Add filter for remote auth enabled hosts -->
                <xpath expr="//filter[@name='pending_migration']" position="after">
                    <separator/>
                    <filter string="Remote Auth Enabled"
                            name="remote_auth_enabled"
                            domain="[('remote_auth_enabled', '=', True)]"/>
                    <filter string="Session Management Enabled"
                            name="session_mgmt_enabled"
                            domain="[('session_mgmt_enabled', '=', True)]"/>
                    <separator/>
                    <filter string="Unprotected" name="unprotected" domain="[('state', '=', 'unprotected')]"/>
                    <filter string="Locked" name="locked" domain="[('state', '=', 'locked')]"/>
                    <filter string="In Deployment" name="deployment" domain="[('state', '=', 'deployment')]"/>
                    <filter string="Protected" name="protected" domain="[('state', '=', 'protected')]"/>
                    <separator/>
                    <filter string="Has Go-Live Date" name="has_golive" domain="[('golive_date', '!=', False)]"/>
                </xpath>
                <!-- Add group by option -->
                <xpath expr="//group" position="inside">
                    <filter string="Remote Auth Status"
                            name="group_remote_auth"
                            context="{'group_by': 'remote_auth_enabled'}"/>
                    <filter string="State" name="groupby_state" context="{'group_by': 'state'}"/>
                    <filter string="Go-Live Date" name="groupby_golive" context="{'group_by': 'golive_date'}"/>
                </xpath>
            </field>
        </record>
    </data>
</odoo>